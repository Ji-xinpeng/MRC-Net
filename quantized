"""
示例：https://developer.aliyun.com/article/1258484#slide-13
"""

import torch
import torch.nn as nn
import torch.nn.functional as F
from torch.quantization import get_default_qconfig
import os
import time
from deals.load_dataset import *
from others.train import *
from torchsummary import summary
from models.models import *
import h5py
from detect_utils.detect_utils import *
import torch.quantization



if __name__ == "__main__":
    # 然后训练一波模型
    train_loader, test_loader = load_dataset()

    # first finetune model on cifar, we don't have imagnet so using cifar as test
    current_file = os.path.abspath(__file__)
    current_directory = os.path.dirname(current_file)
    checkpoint_path_classify = current_directory + '/weights/mobilenetv2classify.pth'
    checkpoint_path_detect = current_directory + '/weights/mobilenetv2detect.pth'
    print(checkpoint_path_classify)
    model = torch.load(checkpoint_path_classify, map_location=torch.device("cpu")) 
    model.eval()

    # 指定量化配置
    model.qconfig = torch.quantization.get_default_qconfig('fbgemm')
    # 准备模型进行后训练静态量化
    torch.quantization.prepare(model, inplace=True)
    # 运行模型，执行校准
    with torch.no_grad():
        for step, inputs in enumerate(train_loader):
            rgb, depth, labels = inputs[0], inputs[1], inputs[2]
            outputs = model(rgb)
    # 将量化方案应用到模型上
    torch.quantization.convert(model, inplace=True)
    # 保存量化模型
    torch.save(model.state_dict(), checkpoint_path_classify = current_directory + '/weights/mobilenetv2classifyquantized_model.pth')
